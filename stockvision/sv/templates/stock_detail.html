<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ stock_data.name }} - Stock Details</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .header {
            font-size: 2rem;
            font-weight: bold;
            color: #0b3954;
        }
        .current-price {
            font-size: 1.5rem;
            color: #0b3954;
            margin-top: 10px;
        }
        .price-summary {
            margin-top: 20px;
            font-size: 1.2rem;
        }
        .price-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .price-table th, .price-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .price-table th {
            background-color: #0b3954;
            color: white;
        }
        .price-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>

    <!-- Load Chart.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="header">{{ stock_data.name }} ({{ stock_data.ticker }})</h1>
        
        {% if latest_price %}
            <p class="current-price">Current Price: ${{ latest_price.close_price }}</p>
        {% else %}
            <p class="current-price">Current Price: Not available</p>
        {% endif %}
        
        <p>Predicted Price: ${{ stock_data.prediction }}</p>

        <div class="price-summary">
            <p>Highest Price in last 6 months: ${{ max_price }}</p>
            <p style="margin-bottom: 50px;">Lowest Price in last 6 months: ${{ min_price }} </p>
        </div>

       <!-- Graph Section for Last 6 Months -->
<!-- Time span selection buttons -->
<div style="margin-bottom: 20px" id="time-span-buttons" >
    <button onclick="updateGraph('1w')">1 Week</button>
    <button onclick="updateGraph('1m')">1 Month</button>
    <button onclick="updateGraph('3m')">3 Months</button>
    <button onclick="updateGraph('6m')">6 Months</button>
</div>

<!-- Move the graph above -->
<canvas id="priceChart" width="400" height="200"></canvas>

<!-- Show other details -->
<p>Latest Price: ${{ latest_price.close_price }}</p>
<p>Max Price in the Last 6 Months: ${{ max_price }}</p>
</div>

<script>
// Original chart data
const chartData = {{ chart_data|safe }};  // Directly use chart_data without JSON.parse

const ctx = document.getElementById('priceChart').getContext('2d');

// Create the initial chart with full data
let priceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.dates,  // Dates on the x-axis
        datasets: [
            {
                label: 'Open Price',
                data: chartData.open_prices,
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                fill: false,
            },
            {
                label: 'Close Price',
                data: chartData.close_prices,
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 2,
                fill: false,
            },
            {
                label: 'High Price',
                data: chartData.high_prices,
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                fill: false,
            },
            {
                label: 'Low Price',
                data: chartData.low_prices,
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 2,
                fill: false,
            }
        ]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                title: { display: true, text: 'Date' },
                type: 'category',
            },
            y: {
                title: { display: true, text: 'Price ($)' }
            }
        }
    }
});

// Function to update the graph based on time span
function updateGraph(timeSpan) {
    let filteredData = {
        dates: [],
        open_prices: [],
        close_prices: [],
        high_prices: [],
        low_prices: []
    };

    const currentDate = new Date();
    let timeLimit;

    // Determine the time limit based on the selected span
    switch (timeSpan) {
        case '1w':
            timeLimit = new Date(currentDate.setDate(currentDate.getDate() - 7)); // 1 week
            break;
        case '1m':
            timeLimit = new Date(currentDate.setMonth(currentDate.getMonth() - 1)); // 1 month
            break;
        case '3m':
            timeLimit = new Date(currentDate.setMonth(currentDate.getMonth() - 3)); // 3 months
            break;
        case '6m':
            timeLimit = new Date(currentDate.setMonth(currentDate.getMonth() - 6)); // 6 months
            break;
        default:
            timeLimit = currentDate;
    }

    // Filter data based on the time limit
    for (let i = 0; i < chartData.dates.length; i++) {
        const date = new Date(chartData.dates[i]);
        if (date >= timeLimit) {
            filteredData.dates.push(chartData.dates[i]);
            filteredData.open_prices.push(chartData.open_prices[i]);
            filteredData.close_prices.push(chartData.close_prices[i]);
            filteredData.high_prices.push(chartData.high_prices[i]);
            filteredData.low_prices.push(chartData.low_prices[i]);
        }
    }

    // Update the chart with the filtered data
    priceChart.data.labels = filteredData.dates;
    priceChart.data.datasets[0].data = filteredData.open_prices;
    priceChart.data.datasets[1].data = filteredData.close_prices;
    priceChart.data.datasets[2].data = filteredData.high_prices;
    priceChart.data.datasets[3].data = filteredData.low_prices;

    // Redraw the chart
    priceChart.update();
}
</script>
            <!-- Price Data Table -->
            <table class="price-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Open</th>
                        <th>High</th>
                        <th>Low</th>
                        <th>Close</th>
                    </tr>
                </thead>
                <tbody>
                    {% for price in stock_prices %}
                    <tr>
                        <td>{{ price.date }}</td>
                        <td>${{ price.open }}</td>
                        <td>${{ price.high }}</td>
                        <td>${{ price.low }}</td>
                        <td>${{ price.close }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
    </div>
</body>
</html>
